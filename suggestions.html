<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #board {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
      }

      .card {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 90%;
        height: 75%;
        border-radius: 1%;
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.1);
        background-color: white;
        transform: translateX(-50%) translateY(-50%) scale(0.95);
      }

      #board .card:first-child {
        transform: translateX(-54%) translateY(-54%) scale(0.95);
      }

      .card-img-top {
        max-height: 80% !important;
        width: auto !important;
      }
      .container {
        max-width: 100%;
        position: relative;
        top: 32px;
        margin: auto;
        margin-bottom: 200px;
      }

      .mdc-tab-bar {
        --mdc-theme-primary: #ff6e83;
        box-shadow: 0px -1px 2px rgba(0, 0, 0, 0.17);
        height: 70px;
      }

      .mdc-tab__content img {
        height: 120%;
      }

      .mdc-tab--active img {
        filter: invert(61%) sepia(29%) saturate(3367%) hue-rotate(311deg)
          brightness(103%) contrast(101%);
      }

      .mdc-ripple-upgraded--background-focused,
      .mdc-text-field {
        background-color: white !important;
      }

      .mdc-tab-icon {
        position: relative;
        top: -10px;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: white;
        overflow-x: hidden;
      }

      .box {
        margin: 0;
        padding: 0;
        position: relative;
        left: 0;
        width: 73.14px;
        height: 74px;
      }

      hr {
        color: rgba(137, 153, 168, 0.8);
        width: 100%;
        position: relative;
        bottom: 0;
      }

      .logo {
        object-fit: contain;
        width: 53px;
        height: 42px;
        margin: auto;
        position: absolute;
        top: 4px;
        left: 0;
        right: 0;
        bottom: 4px;
        display: block;
      }
    </style>
  </head>

  <body class="mdc-typography">
    <header
      style="
        position: fixed;
        width: 100%;
        z-index: 100;
        background-color: white;
      "
    >
      <div class="box">
        <img class="logo" src="../icons/Logo-whitebg.png" />
      </div>
      <hr style="margin: 0;" />
    </header>
    <div id="board"></div>
    <div
      class="mdc-tab-bar"
      role="tablist"
      style="
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 100;
        background-color: white;
      "
    >
      <div class="mdc-tab-scroller">
        <div
          class="mdc-tab-scroller__scroll-area mdc-tab-scroll-area--scroll"
          style="overflow-y: hidden; margin-bottom: 0;"
        >
          <div class="mdc-tab-scroller__scroll-content">
            <!--Matchmaking-->
            <button
              id="mdc-tab-1"
              class="mdc-tab mdc-tab--active mdc-ripple-upgraded"
              role="tab"
              aria-selected="true"
              tabindex="0"
            >
              <span class="mdc-tab__content">
                <span class="mdc-tab__icon" aria-hidden="true">
                  <img src="../icons/match.png" />
                </span>
              </span>

              <span class="mdc-tab-indicator">
                <span
                  class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"
                  style="border-color: transparent !important;"
                ></span>
              </span>
            </button>
            <!--Messaging-->
            <button
              id="mdc-tab-2"
              class="mdc-tab mdc-ripple-upgraded"
              role="tab"
              aria-selected="true"
              tabindex="0"
            >
              <span class="mdc-tab__content">
                <span class="mdc-tab__icon" aria-hidden="true">
                  <img src="../icons/message.png" />
                </span>
              </span>

              <span class="mdc-tab-indicator">
                <span
                  class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"
                  style="border-color: transparent !important;"
                ></span>
              </span>
            </button>
            <!--Profile-->
            <button
              id="mdc-tab-3"
              class="mdc-tab mdc-ripple-upgraded"
              role="tab"
              aria-selected="true"
              tabindex="0"
            >
              <span class="mdc-tab__content">
                <span class="mdc-tab__icon" aria-hidden="true">
                  <img src="../icons/profile.png" />
                </span>
              </span>

              <span class="mdc-tab-indicator">
                <span
                  class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"
                  style="border-color: transparent !important;"
                ></span>
              </span>
            </button>
            <!--Settings-->
            <button
              id="mdc-tab-4"
              class="mdc-tab mdc-ripple-upgraded"
              role="tab"
              aria-selected="true"
              tabindex="0"
            >
              <span class="mdc-tab__content">
                <span class="mdc-tab__icon" aria-hidden="true">
                  <img src="../icons/settings.png" />
                </span>
              </span>

              <span class="mdc-tab-indicator">
                <span
                  class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"
                  style="border-color: transparent !important;"
                ></span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="mdc-dialog">
      <div class="mdc-dialog__container">
        <div
          class="mdc-dialog__surface"
          role="alertdialog"
          aria-modal="true"
          aria-labelledby="my-dialog-title"
          aria-describedby="my-dialog-content"
        >
          <div class="mdc-dialog__content" id="my-dialog-content">
            <h2>User Profile</h2>
            Amet reprehenderit laudantium earum nemo totam, veritatis
            Accusantium neque quis dolorum placeat ullam. Reprehenderit hic sed
            odio recusandae rem Sapiente nisi laboriosam dolorum rerum
            voluptatem Sed perferendis fugiat assumenda natus.
          </div>
        </div>
      </div>
      <div class="mdc-dialog__scrim"></div>
    </div>
  </body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script>
  new mdc.tabBar.MDCTabBar(document.querySelector('.mdc-tab-bar'));
  class Carousel {
    constructor(element) {
      this.board = element;
      this.push();
      this.push();
      this.push();
      this.handle();
    }

    handle() {
      this.cards = this.board.querySelectorAll('.card');
      this.topCard = this.cards[this.cards.length - 1];
      this.nextCard = this.cards[this.cards.length - 2];
      if (this.cards.length > 0) {
        this.topCard.style.transform =
          'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(0deg) scale(1)';
        if (this.hammer) this.hammer.destroy();
        this.hammer = new Hammer(this.topCard);
        this.hammer.add(new Hammer.Tap());
        this.hammer.add(
          new Hammer.Pan({
            position: Hammer.position_ALL,
            threshold: 0,
          })
        );

        this.hammer.on('tap', (e) => {
          this.onTap(e);
        });
        this.hammer.on('pan', (e) => {
          this.onPan(e);
        });
      }
    }

    onTap(e) {
      let propX =
        (e.center.x - e.target.getBoundingClientRect().left) /
        e.target.clientWidth;
      let rotateY = 15 * (propX < 0.05 ? -1 : 1);
      this.topCard.style.transition = 'transform 100ms ease-out';
      this.topCard.style.transform =
        'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(' +
        rotateY +
        'deg) scale(1)';

      setTimeout(() => {
        this.topCard.style.transform =
          'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(0deg) scale(1)';
      }, 100);
    }

    onPan(e) {
      if (!this.isPanning) {
        this.isPanning = true;
        this.topCard.style.transition = null;
        if (this.nextCard) this.nextCard.style.transition = null;
        let style = window.getComputedStyle(this.topCard);
        let mx = style.transform.match(/^matrix\((.+)\)$/);
        this.startPosX = mx ? parseFloat(mx[1].split(', ')[4]) : 0;
        this.startPosY = mx ? parseFloat(mx[1].split(', ')[5]) : 0;
        let bounds = this.topCard.getBoundingClientRect();
        this.isDraggingFrom =
          e.center.y - bounds.top > this.topCard.clientHeight / 2 ? -1 : 1;
      }

      let posX = e.deltaX + this.startPosX;
      let posY = e.deltaY + this.startPosY;
      let propX = e.deltaX / this.board.clientWidth;
      let propY = e.deltaY / this.board.clientHeight;
      let dirX = e.deltaX < 0 ? -1 : 1;
      let deg = this.isDraggingFrom * dirX * Math.abs(propX) * 45;
      let scale = (95 + 5 * Math.abs(propX)) / 100;

      this.topCard.style.transform =
        'translateX(' +
        posX +
        'px) translateY(' +
        posY +
        'px) rotate(' +
        deg +
        'deg) rotateY(0deg) scale(1)';

      if (this.nextCard)
        this.nextCard.style.transform =
          'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(0deg) scale(' +
          scale +
          ')';

      if (e.isFinal) {
        this.isPanning = false;
        let successful = false;

        this.topCard.style.transition = 'transform 200ms ease-out';
        if (this.nextCard)
          this.nextCard.style.transition = 'transform 100ms linear';

        if (propX > 0.25 && e.direction == Hammer.DIRECTION_RIGHT) {
          successful = true;
          posX = this.board.clientWidth;
        } else if (propX < -0.25 && e.direction == Hammer.DIRECTION_LEFT) {
          successful = true;
          posX = -(this.board.clientWidth + this.topCard.clientWidth);
        } else if (propY < -0.25 && e.direction == Hammer.DIRECTION_UP) {
          successful = true;
          posY = -(this.board.clientHeight + this.topCard.clientHeight);
        } else if (propY > 0.25 && e.direction == Hammer.DIRECTION_DOWN) {
          successful = true;
          posY = this.topCard.clientHeight;
        }

        if (successful) {
          this.topCard.style.transform =
            'translateX(' +
            posX +
            'px) translateY(' +
            posY +
            'px) rotate(' +
            deg +
            'deg)';

          setTimeout(() => {
            if (e.direction !== Hammer.DIRECTION_UP) {
              this.board.removeChild(this.topCard);
              this.push();
              this.handle();
            } else if (e.direction === Hammer.DIRECTION_UP) {
              dialog.open();
              this.topCard.style.transform =
                'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(0deg) scale(1)';
              if (this.nextCard)
                this.nextCard.style.transform =
                  'translateX(-54%) translateY(-54%) rotate(0deg) rotateY(0deg) scale(0.95)';
            }
          }, 200);
        } else {
          this.topCard.style.transform =
            'translateX(-50%) translateY(-50%) rotate(0deg) rotateY(0deg) scale(1)';
          if (this.nextCard)
            this.nextCard.style.transform =
              'translateX(-54%) translateY(-54%) rotate(0deg) rotateY(0deg) scale(0.95)';
        }
      }
    }
    push() {
      if (users.length) {
        console.log(users);
        let card = document.createElement('div');
        card.classList.add('card');
        let img = document.createElement('img');
        img.classList.add('card-img-top');
        img.setAttribute('src', users[0]?.picture.originalImage);
        let body = document.createElement('div');
        body.classList.add('card-body');
        body.innerHTML = `<div class="card-title"><span class="h4">${users[0]?.username}, </span><span style="color: gray">${users[0].age}</span></div><p class="card-text">Some quick example text to build on the card title and make up the bulk of the cards content.</p>`;
        card.append(img);
        card.append(body);
        this.board.insertBefore(card, this.board.firstChild);
        users = users.slice(1);
      }
    }
  }

  let users;
  const app = async () => {
    let board = document.querySelector('#board');
    let dialog = new mdc.dialog.MDCDialog(
      document.querySelector('.mdc-dialog')
    );

    let res = await fetch('http://192.168.1.12:5000/api/suggestions/', {
      headers: {
        authorization:
          localStorage.getItem('access_token') ||
          'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZGRyZXNzIjp7InBvc3RhbENvZGUiOiIiLCJjaXR5IjoiIiwicHJvdmluY2UiOiIiLCJjb3VudHJ5IjoiIiwibGF0aXR1ZGUiOiIiLCJsb25naXR1ZGUiOiIifSwibW9iaWxlTnVtYmVyIjoiMDkxMjM0NTY3ODkiLCJmYWNlYm9va0lkIjoiIiwiZ21haWwiOiIiLCJzZXgiOiIiLCJzaG93QWN0aXZlU3RhdHVzIjp0cnVlLCJhY3RpdmVTdGF0dXMiOiJvbmxpbmUiLCJ2ZXJpZmljYXRpb25TdGF0dXMiOiJ1bnZlcmlmaWVkIiwiZW1wbG95bWVudCI6IiIsImJsb2NrZWRVc2VycyI6W10sImxlZnRDb252ZXJzYXRpb25zIjpbXSwiX2lkIjoiNjBkOWVmZDRjYmE0ZTA5YzQ2YzcyYzcwIiwidXNlcm5hbWUiOiJyYXVsMTkiLCJmaXJzdE5hbWUiOiJSYXVsIiwibGFzdE5hbWUiOiJEaWV0cmljaCIsIm9yaWVudGF0aW9uIjoiU3RyYWlnaHQgKG1hbGUpIiwiYmlydGhkYXkiOiIxOTk1LTA0LTE5VDAyOjUxOjQzLjQ2NVoiLCJfX3YiOjAsImlhdCI6MTYyNDg5NTQ0NH0.XkOmO1cv-WTApC4BUToHwV-SS1F6TQWx4R5QxmiSdN8',
      },
    });

    res = await res.json();
    users = res.users;
    let carousel = new Carousel(board);
  };
  app();
</script>
