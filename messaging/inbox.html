<!DOCTYPE html>
<html lang="en-us">
<!--inbox-->

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--font awesome script-->

    <script src="https://kit.fontawesome.com/bcbd543404.js" crossorigin="anonymous"></script>
    <!-- Bootstrap cdn link-->
    <!--Bootstrap script-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js " integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4 " crossorigin="anonymous "></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js " integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p " crossorigin="anonymous "></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js " integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT " crossorigin="anonymous "></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!--Material.io links-->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <!--google fonts-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!--CSS-->
    <link rel="stylesheet" type="text/css" href="../css/inbox.css">
    <meta name="viewport" media content="width=device-width, initial-scale=1.0">
</head>
<style>
    .container {
        max-width: 100%;
        position: relative;
        top: 32px;
        margin: auto;
        margin-bottom: 200px;
    }
    
    .mdc-tab-bar {
        --mdc-theme-primary: #ff6e83;
        box-shadow: 0px -1px 2px rgba(0, 0, 0, 0.17);
        height: 70px;
    }
    
    .mdc-tab__content img {
        height: 120%;
    }
    
    .mdc-tab--active img {
        filter: invert(61%) sepia(29%) saturate(3367%) hue-rotate(311deg) brightness(103%) contrast(101%);
    }
    
    .mdc-ripple-upgraded--background-focused,
    .mdc-text-field {
        background-color: white !important;
    }
    
    .mdc-tab-icon {
        position: relative;
        top: -10px;
    }
</style>

<body>
    <header style="position: fixed; width: 100%; z-index: 100; background-color: white;">
        <div class="box">
            <img class="logo" src="../icons/Logo-whitebg.png">
        </div>
        <hr style="margin: 0;">
    </header>
    <br>
    <br>
    <div class="container">
        <!--div for each message
                            hr class="dropdown-divider"
                            -->
        <!--sample message inbox-->
        <div class="message-div" id="all-users"></div>

    </div>
    <!--tabs-->
    <div class="mdc-tab-bar" role="tablist" style="position: fixed; bottom: 0; left: 0; z-index: 100; background-color: white;">
        <div class="mdc-tab-scroller">
            <div class="mdc-tab-scroller__scroll-area mdc-tab-scroll-area--scroll" style="overflow-y:hidden; margin-bottom: 0;">
                <div class="mdc-tab-scroller__scroll-content">
                    <!--Matchmaking-->
                    <button id="mdc-tab-1" class="mdc-tab mdc-tab--active mdc-ripple-upgraded" role="tab" aria-selected="true" tabindex="0">
                            <span class="mdc-tab__content">
                                <span class="mdc-tab__icon" aria-hidden="true">
                                    <img src="../icons/match.png">
                                </span>
                            </span>
                               
                            <span class="mdc-tab-indicator">
                                 <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline" style="border-color: transparent !important;"></span>
                            </span>
                           
                        </button>
                    <!--Messaging-->
                    <button id="mdc-tab-2" class="mdc-tab mdc-ripple-upgraded" role="tab" aria-selected="true" tabindex="0">
                             <span class="mdc-tab__content">
                                <span class="mdc-tab__icon" aria-hidden="true">
                                    <img src="../icons/message.png">
                                </span>
                            </span>
                               
                             <span class="mdc-tab-indicator">
                                 <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline" style="border-color: transparent !important;"></span>
                            </span>
                        </button>
                    <!--Profile-->
                    <button id="mdc-tab-3" class="mdc-tab mdc-ripple-upgraded" role="tab" aria-selected="true" tabindex="0">
                             <span class="mdc-tab__content">
                                <span class="mdc-tab__icon" aria-hidden="true">
                                    <img src="../icons/profile.png">
                                </span>
                            </span>
                               
                             <span class="mdc-tab-indicator">
                                 <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline" style="border-color: transparent !important;"></span>
                            </span>
                            
                        </button>
                    <!--Settings-->
                    <button id="mdc-tab-4" class="mdc-tab mdc-ripple-upgraded" role="tab" aria-selected="true" tabindex="0">
                             <span class="mdc-tab__content">
                                <span class="mdc-tab__icon" aria-hidden="true">
                                    <img src="../icons/settings.png">
                                </span>
                            </span>
                           
                             <span class="mdc-tab-indicator">
                                 <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline" style="border-color: transparent !important;"></span>
                            </span>
                        </button>
                </div>
            </div>

        </div>
    </div>
    <script>
        new mdc.tabBar.MDCTabBar(document.querySelector('.mdc-tab-bar'));
    </script>
</body>
</html>
<script src="https://cdn.socket.io/4.1.1/socket.io.min.js" integrity="sha384-cdrFIqe3RasCMNE0jeFG9xJHog/tgOVC1E9Lzve8LQN1g5WUHo0Kvk1mawWjxX7a" crossorigin="anonymous"></script>
<script src="../scripts/constants.js"></script>
<script>
  localStorage.setItem('user_id', '60e5b724efb8393b2ebcef8d');
  localStorage.getItem('access_token', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZGRyZXNzIjp7InBvc3RhbENvZGUiOiIiLCJjaXR5IjoiU29tZSBDaXR5IiwicHJvdmluY2UiOiIiLCJjb3VudHJ5IjoiIiwibGF0aXR1ZGUiOiIxNC4wMDE2MjIzMjg5NzEwNzkiLCJsb25naXR1ZGUiOiIxMjEuNjYwOTUwMTEwOTQwOCJ9LCJtb2JpbGVOdW1iZXIiOiIwOTEyMzQ1Njc4OSIsImZhY2Vib29rSWQiOiIiLCJnbWFpbCI6IiIsInNleCI6IiIsInNob3dBY3RpdmVTdGF0dXMiOnRydWUsImFjdGl2ZVN0YXR1cyI6Im9ubGluZSIsInZlcmlmaWNhdGlvblN0YXR1cyI6InVudmVyaWZpZWQiLCJlbXBsb3ltZW50IjoiIiwiYmxvY2tlZFVzZXJzIjpbXSwibGVmdENvbnZlcnNhdGlvbnMiOltdLCJfaWQiOiI2MGU1YjcyNGVmYjgzOTNiMmViY2VmOGQiLCJ1c2VybmFtZSI6ImphY3F1ZXMyMiIsImZpcnN0TmFtZSI6IkphY3F1ZXMiLCJsYXN0TmFtZSI6IkFiZXJuYXRoeSIsIm9yaWVudGF0aW9uIjoiU3RyYWlnaHQgKG1hbGUpIiwiYmlydGhkYXkiOiIyMDcxLTA1LTIyVDExOjI3OjEyLjkwOVoiLCJfX3YiOjAsImlhdCI6MTYyNTY2NzM2NH0.KKqiqgxP_sj9Rap_NDX7BGo7Q8KnhMoOvYMeVHY8g1I')

  const redirect = (username) => {
          location.href = './chatbox.html#' + username;
        }
        (function(){
            // Connect to socket.io
            var socket = io(WS_URL);
            // Check for connection
            if(socket !== undefined){
                console.log('Connected to socket...');
                // Handle Output
                socket.emit('viewAllUsers', localStorage.getItem('user_id'));
                socket.on('showAllUsers', function(data) {
                  data.map(user => {
                    time = new Date(user.timeSent)
                    time = time.toString().split(' ')[4].split(':').slice(0,2);
                    time[0] = time[0] > 12 ? time[0]-12 : time[0];
                    ext = time[0] > 12 ? 'PM' : 'AM';
                    time[0] = time[0] === '00' ? '12' : time[0];
                    ext = time[0] === '00' ? 'AM' : 'PM';
                    time = time.join(':').concat(' ').concat(ext)
                    document.getElementById('all-users').innerHTML += `
            <div class="message-item" onclick="redirect('${user._id}')" id="${user._id}">
                <div class="message-item--div">
                    <div class="messaged-user-photo">
                        <img src="${user.picture.blurredImage}" class="thumbnail">
                    </div>
                    <div class="messaged-user">
                        <h4 class="user-name">${user.username}</h4>
                        <p class="message">${user.latestMessage}
                            <p class="time">${time}</p>
                        </p>
                    </div>
                </div>
                <br>
                <hr class="dropdown-divider">
            </div>`
                  })
                  console.log(data);
                })

                socket.on('newMessage', function(data) {
                  let chat = data.chats[0];
                  let me = chat.senderId === localStorage.getItem('user_id') ? 'sender' : 'receiver';
                  let otherUser = me === 'sender' ? 'receiver' : 'sender';
                  console.log(data)
                  document.getElementById(data[otherUser]._id)?.remove();
                  time = new Date(chat.timeSent)
                  time = time.toString().split(' ')[4].split(':').slice(0,2);
                  time[0] = time[0] > 12 ? time[0]-12 : time[0];
                  ext = time[0] > 12 ? 'PM' : 'AM';
                  time[0] = time[0] === '00' ? '12' : time[0];
                  ext = time[0] === '00' ? 'AM' : 'PM';
                  time = time.join(':').concat(' ').concat(ext)
                  let temp = document.getElementById('all-users').innerHTML;
                  document.getElementById('all-users').innerHTML = `
            <div class="message-item" onclick="redirect('${data[otherUser]._id}')" id="${data[otherUser]._id}">
                <div class="message-item--div">
                    <div class="messaged-user-photo">
                        <img src="${data[otherUser].picture.blurredImage}" class="thumbnail">
                    </div>
                    <div class="messaged-user">
                        <h4 class="user-name">${data[otherUser].username}</h4>
                        <p class="message">${chat.body}
                            <p class="time">${time}</p>
                        </p>
                    </div>
                </div>
                <br>
                <hr class="dropdown-divider">
            </div>`+temp;
              });
            }
        })();
</script>
