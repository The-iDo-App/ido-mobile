<!DOCTYPE html>
<html lang="en-us">
<!--inbox-->

<head>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--font awesome script-->

    <script src="https://kit.fontawesome.com/bcbd543404.js" crossorigin="anonymous"></script>
    <!-- Bootstrap cdn link-->
    <!--Bootstrap script-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js " integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4 " crossorigin="anonymous "></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js " integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p " crossorigin="anonymous "></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js " integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT " crossorigin="anonymous "></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--Material.io links-->
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <!--google fonts-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!--CSS-->
    <link rel="stylesheet" type="text/css" href="../css/chatbox.css">
    <meta name="viewport" media content="width=device-width, initial-scale=1.0">
</head>
<style>
    .container {
        width: 100%;
    }
    
    .chat-box {
        position: relative;
        top: 71px;
        height: auto;
    }
    
    .match-user {
        color: #8999a8;
    }
    
    .time {
        position: relative;
        top: 10px;
        color: #8999a8;
        font-weight: 300;
    }
    
    #time2 {
        position: relative;
        color: #8999a8;
        font-weight: 300;
    }
    
    #message1 {
        max-width: 70%;
        position: relative;
        float: left;
        vertical-align: middle;
        border: 0.5px solid #8999A8;
    }
    
    .message-chat {
        position: relative;
        font-size: 15px;
        top: 5px;
        line-height: 20px;
        color: #8999a8;
    }
    
    #message2 {
        max-width: 70%;
        float: right;
        position: relative;
        background-color: #1381a2;
        border-color: #1381a2;
        color: white;
    }
    
    .message-settings {
        width: 60%;
        position: relative;
        top: 23px;
    }
    
    .message-balloon {
        height: 100%;
        max-width: height;
    }
    
    .chat-chat .message-balloon {
        height: auto;
    }
    
    .action {
        float: right;
        margin-top: 2px;
        font-weight: 300;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 12px;
        color: #8999a8;
    }
    
    .elipsis {
        float: left;
        font-weight: 300;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 12px;
        color: #8999a8;
    }
</style>

<body>
    <header style="position: fixed; top: 0; width: 100%; height: 74px; z-index: 100; background-color: white; ">
        <div class="box">
            <!--Message header-->
            <div class="container my-0 ">
                <div class="row row-height my-0">
                    <div class="col-2">
                        <a href="inbox.html" class="backBtn">
                            <i class="fa fa-arrow-left text-center my-3" style="font-size: 25px; width: 100%;position: relative; top: 17px; left: 10px; color: #8999a8;"></i>
                        </a>

                    </div>
                    <div class="col-3 mx-auto">
                        <div class="text-center">
                            <img class="thumbnail
                            img-thumbnail mx-auto my-2 d-block
                            " src="../photos/2.png" id="receiver-image">
                        </div>
                    </div>
                    <div class="col-5 mx-0">
                        <h4 class="user-name mx-0 my-4 center-block" id="receiver-username">Gray</h4>
                    </div>
                    <div class="col-2">
                        <img class="img-fluid message-settings mx-auto text-center center-block" onclick="window.location.href='message-settings.html'" src="../icons/others.png">
                    </div>
                </div>
            </div>


        </div>
        <hr style="margin: 0; z-index: 1000;">
    </header>
    <!--Message body-->
    <div class="container chat-box my-2 mx-auto" id="chat-box">
        <div class="row chat-chat" id="messages">
            <div class="col-12 pt-2">
                <br>
                <!-- <span class="text-center center-block match-user">You match with Gray! Say something.</span> -->
            </div>
            <!-- <div class="col-12"> -->
            <!--     <span class="action">seen</span> -->
            <!-- </div> -->
            <!-- <div class="col-12"> -->
            <!--     <span class="elipsis">Gray is typing...</span> -->
            <!-- </div> -->
        </div>

    </div>
    <!--Message footer-->
    <div class="container  message mx-auto">
        <div class="row row-message">
            <div class="col-12 message-box">
                <input class="shadow-none message-input" type="text" id='chatArea' placeholder="Type a message...">
            </div>
            <div class="col-10">
                <div class="container">
                    <div class="row icons">
                        <div class="col-4 mx-0">
                            <img class="message-icons img-fluid" src="../icons/gallery.png">
                        </div>
                        <div class="col-4 mx-0">
                            <img class="message-icons img-fluid" src="../icons/gif.png">
                        </div>
                        <div class="col-4 mx-0">
                            <img class="message-icons img-fluid" src="../icons/emoji.png">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-2 col-send">
                <a href='#' class="send mx-auto text-center center-block " id="send-button">
                    <span class="glyphicon glyphicon-send mx-auto "></span>
                </a>
            </div>
        </div>
    </div>
</body>
</html>
<script src="https://cdn.socket.io/4.1.1/socket.io.min.js" integrity="sha384-cdrFIqe3RasCMNE0jeFG9xJHog/tgOVC1E9Lzve8LQN1g5WUHo0Kvk1mawWjxX7a" crossorigin="anonymous"></script>
<script src="../scripts/constants.js"></script>
<script>
  if(location.hash.length!==25) location.href = './inbox.html';
  (function(){
            var element = function(id){
                return document.getElementById(id);
            }

            // Get Elements
            var messages = element('messages');
            var textarea = element('chatArea');

            // Connect to socket.io
            var socket = io(WS_URL);

            // Check for connection
            if(socket !== undefined){
                console.log('Connected to socket...');

                // Handle Output
                socket.emit('viewOne', { from: localStorage.getItem('user_id'), to: location.hash.slice(1) });
                socket.on('showChat', function(data){
                  console.log(data)
                  if(data.first) {
                    element('receiver-image').setAttribute('src', data.receiver.picture.blurredImage);
                    element('receiver-username').innerText = data.receiver.username;
                  }
                    console.log(data)
                    data = data.chats;
                    if(data.length){
                        for(var x = 0;x < data.length;x++){
                            // Build out message div
                          let time = new Date(data[x].timeSent).toString();
                          time = time.split(' ')[4].split(':').slice(0,2);
                          let ext = time[0] >= 12 ? ' PM' : ' AM';
                          time[0] = time[0] == 0 ? '12' : time[0];
                          time[0] = time[0] >= 12 ? time[0]-12 : time[0];
                          time = time.join(':').concat(ext)
                          let fromSelf = data[x].senderId === localStorage.getItem('user_id');
                          messages.innerHTML += `
            <div class="col-12">
                <span class="text-center center-block time" id="time2">${time}</span>
            </div>
            <div class="col-12 message-balloon text-wrap">
                <div class="card text-wrap" id="message${fromSelf ? 2 : 1}">
                    <div class="card-body">
                            <p class="message-chat ${fromSelf ? 'text-light' : ''}">${data[x].body}</p>
                    </div>
                </div>
            </div>`
                          element('chat-box').scrollTop = messages.scrollHeight;
                        }
                    }
                });

                // Handle Input
                textarea.addEventListener('keydown', function(event){
                    if(event.which === 13 && event.shiftKey == false){
                        // Emit to server input
                        socket.emit('input', {
                            from: localStorage.getItem('user_id'),
                            to: location.hash.slice(1),
                            message:textarea.value
                        });

                        textarea.value = '';

                        event.preventDefault();
                    }
                })
                element('send-button').addEventListener('click', function(event){
                        // Emit to server input
                        socket.emit('input', {
                            from: localStorage.getItem('user_id'),
                            to: location.hash.slice(1),
                            message:textarea.value
                        });

                        textarea.value = '';

                        event.preventDefault();
                })
            }
        })();
</script>
